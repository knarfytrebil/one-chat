<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="http://117.102.189.222:8001/static/js/jquery-1.7.1.min.js"></script>
<script src="http://117.102.189.222:8001/static/js/bootstrap.min.js"></script>
<script src="http://117.102.189.222:8001/static/js/bootstrap-tab.js"></script>
<script src="http://117.102.189.222:8001/static/js/bootstrap-typeahead.js"></script>
<script src="http://117.102.189.222:8001/static/js/bootstrap-button.js"></script>
<script src="http://117.102.189.222:8001/static/js/flot.js"></script>
<script src="http://117.102.189.222:8001/static/socket.io.js"></script>
<script type="text/javascript" src="http://117.102.189.222:8001/static/js/jquery.flot.js"></script>
<script type="text/javascript" src="http://117.102.189.222:8001/static/js/jquery.flot.pie.js"></script>
<script type="text/javascript" src="http://117.102.189.222:8001/static/js/jquery.flot.resize.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
<title>能焰实时统计系统 ALPHA</title>
	<link href="http://117.102.189.222:8001/static/css/bootstrap.min.css" rel="stylesheet">
	<link href="http://117.102.189.222:8001/static/css/bootstrap-responsive.min.css" rel="stylesheet">
	<link href="http://117.102.189.222:8001/static/css/style.css" rel="stylesheet">
</head>

<body id="bd">
<div class="container-fluid" id="main-scroll">
	  <div class="row-fluid">
		<div class="span3 bg-none">
			<div class="span3-con">
				<div class="well">
					<span id = "users"></span>
					<span id = "ping"></span>
					<span id = "admin"></span>
				</div>
			</div>
				<!--chart-->
      <div class="well chart clearfix">
      	<div class="chart-item" id="chart1">
        	<script type="text/javascript">
				$(function () {
					var d1 = [[1, 10], [2, 2], [3, 3],[5,5],[6,5]];
					$.plot($("#chart1"), [d1]);
				});
				
            </script>
        </div>
        <br>
        <div class="chart-item" id="chart2">
        	<script type="text/javascript">
				var data = [];
					var series = Math.floor(Math.random()*6)+1;
					for( var i = 0; i<series; i++)
					{
						data[i] = { label: "Series"+(i+1), data: Math.floor(Math.random()*100)+1 }
					}
				
					// DEFAULT
				$.plot($("#chart2"), data,
				{
						series: {
							pie: { 
								innerRadius: 0.5,
								show: true
							}
						}
				});
            </script>
        </div>
        
         <div class="chart-item" id="chart3">
        	<script type="text/javascript">
				var data = [];
					var pp = Math.floor(Math.random()*6)+1;
					for( var i = 0; i<pp; i++)
					{
						data[i] = { label: "pp"+(i+1), data: Math.floor(Math.random()*20)+1 }
					}
				
					// DEFAULT
				$.plot($("#chart3"), data,
				{
						series: {
							pie: { 
								innerRadius: 0.5,
								show: true
							}
						}
				});
            </script>
        </div>
        
      </div>
   <!--chart end-->
		</div>
		<div class="span6">
		 <table class="table table-striped" id="chattings">
			  <tr>
				<td width="120"><span class="label label-success">133013960418905</span><div><i class="icon-time"></i>11:31:31</div></td>
				<td>Mark</td>
			  </tr>
			  <tr>
				<td><span class="label label-success">133013960418905</span><div><i class="icon-time"></i>11:31:31</div></td>
				<td>JacobJacobJacobJacobJacobJacobJacob</td>
			  </tr>
			  <tr>
				<td><span class="label label-important">133013960418905</span><div><i class="icon-time"></i>11:31:31</div></td>
				<td>Stu</td>
			  </tr>
			  <tr>
				<td><span class="label label-info">133013960418905</span><div><i class="icon-time"></i>11:31:31</div></td>
				<td>JacobJacobJacobJacobJacobJacobJacob</td>
			  </tr>
			  <tr>
				<td><span class="label">133013960418905</span><div><i class="icon-time"></i>11:31:31</div></td>
				<td>Stu</td>
			  </tr>
		  </table>
		</div>
		<div class="span3">
			<ul class="nav nav-list">
			  <li class="active"><span class="label label-success">邮件</span><a href="#">133013960418905</a></li>
			  <li><span class="label">野人</span><a href="#">133013960418905</a></li>
			  <li><span class="label label-important">其他</span><a href="#">133013960418905</a></li>
			  <li><span class="label label-info">搜索引擎</span><a href="#">133013960418905</a></li>
			 </ul>          
		</div>
		
	  </div>
	  
</div>
<div class="navbar-inner-bottom">
	<a herf class = "brand">Sta:Chat</a>
	<button class="btn btn-primary" data-toggle="button" id="casting" onclick="javascript:toggleCast();">BroadCast</button>
	<form id = "chatform">
	<input type="text" id="chat"/>
	</form>
</div>
<script type="text/javascript">
	///Initiating the global variables
	var uid = "";
	var cast = 0;
	$(function(){

		///CSS Tweaks
		$(".span3").height($(window).height()-55)
		$(".span6").height($(window).height()-55);
		$(".r-s").width($(".span3").width());
		
		$("#chat").width($(".span6").width())
		var wd = $(".span6").width();
	
		$("#chat").css("margin-left",-wd/2)
		$(".well").width($(".span3").width());
		$(".table-striped").scrollTop($(".table-striped")[0].scrollHeight);

		///WebSocket Starts
		var host = "117.102.189.222";
		WEB_SOCKET_SWF_LOCATION = 'http://' + host + ':8001/static/WebSocketMain.swf';
		var s = new io.connect('http://' + host + ':8002/chat', {
			rememberTransport: false
			});
		var ping = new io.connect('http://' + host + ':8002/ping');
		
		// Establish event handlers
		s.on('disconnect', function() {
			sock.socket.reconnect();
		});
		
		function getPrintableDate(date) {
		  return date.getFullYear().toString() + '/' +
			 (date.getMonth()+1).toString() + '/' +
			 date.getDate().toString() + ' ' +
			 date.getHours().toString() + ':' +
			 date.getMinutes().toString() + ':' +
			 date.getSeconds().toString() + '.' +
			 date.getMilliseconds().toString();
		}

		function encodeDate(date)
		{
			return [date.getHours(), date.getMinutes(), date.getSeconds(), date.getMilliseconds()];
		}

		function decodeDate(data)
		{
			var date = new Date();
			return new Date(date.getFullYear(), date.getMonth(), date.getDate(),
							data[0], data[1], data[2], data[3]);
		}

		// Ping
		ping.on('message', function(data) {
			var client = decodeDate(data.client);
			var server = decodeDate(data.server);
			var total = data.total;
			var admin = data.admin;
			var now = new Date();

			$('#users').text(total);
			$('#ping').text((now.getTime() - client.getTime()).toString());
			$('#admin').text(admin);            

		});

		function sendPing()
		{
			ping.json.send({client: encodeDate(new Date()) });
			setTimeout(sendPing, 5000);
		}
		
		//now time
		function pubDate(){
			var date = new Date()
			var h = date.getHours(); 
			var m = date.getMinutes(); 
			var se = date.getSeconds(); 
			return (h<10 ? "0"+ h : h) +":" +(m<10 ? "0" + m : m) +":" +(se<10 ? "0" +se : se);
		}
		sendPing();

		s.on('connect', function() {
			s.send('{"type":"sys","content":"Connected ...."}');
			s.send('{"type":"IdentifyAdminNow","content":"K2i1l3l4T5heZombies"}');
		});

		s.on('message', function(data) {
			if (data.sys != undefined) {
				$("#chattings").prepend("<tr><td><span class='label label-info'>SERVICE</span><div><i class='icon-time'></i>"+pubDate()+"</div></td><td>"+ data.sys +"</td></tr>");
			}else if( data.chat != undefined){
				$("#chattings").prepend("<tr><td><span class='label label-important'>"+data.nick+ "</span><div><i class='icon-time'></i>"+ pubDate()+"</div></td><td>" + data.chat +"</td></tr>");
			}else if (data.uid != undefined ){
				uid = data.uid
			};
		});

		//send the message when submit is clicked
		$('#chatform').submit(function (evt) {
			var line = $('#chatform [type=text]').val();
			$('#chatform [type=text]').val('');
			var broad = "BroadCast#"
			if (cast == 0) {
				broad = "";
			};
			s.send('{"type":"' + uid + '","content":"' + broad + line + '"}');
			return false;
		});
	});
	///Other Functions
	function toggleCast()
	{	
		$('#casting').button('toggle');
		if (cast == 0) {
			cast = 1;
		}else{
			cast = 0
		};
	}
</script>
</body>
</html>
